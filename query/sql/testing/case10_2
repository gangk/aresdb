WITH m1 (Requested) AS (SELECT count(*) AS Requested
FROM trips
  LEFT JOIN trips AS rush_leg
    ON trips.workflow_uuid=rush_leg.workflow_uuid AND status='completed'
  LEFT JOIN api_cities AS cities
    ON cities.id=city_id
WHERE aql_time_filter(request_at, "96 quarter-hours ago", "1 quarter-hours ago", America/New_York) AND marketplace="agora"
GROUP BY aql_time_bucket_day(request_at, "minute", America/New_York), aql_numeric_bucket_logbase(pop, 2)),
m2 (Completed) AS   
(SELECT count(*) AS Completed
FROM trips
  LEFT JOIN trips AS rush_leg
    ON trips.workflow_uuid=rush_leg.workflow_uuid AND status='completed'
  LEFT JOIN api_cities AS cities
    ON cities.id=city_id
WHERE aql_time_filter(request_at, "96 quarter-hours ago", "1 quarter-hours ago", America/New_York) AND marketplace="agora" AND status='completed'
GROUP BY aql_time_bucket_day(request_at, "minute", America/New_York), aql_numeric_bucket_logbase(pop, 2))
SELECT Completed/Requested
FROM m1 NATURAL LEFT JOIN m2;
